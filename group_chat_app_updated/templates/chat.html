<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.room_name }} - Group Chat</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* BUBBLES */
        .bubbles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .bubble { position: absolute; bottom: -150px; border-radius: 50%; opacity: 0.7; animation: rise 15s infinite ease-in; }
        .bubble:nth-child(1) { width: 60px; height: 60px; left: 10%; background: radial-gradient(circle, #4facfe, #00f2fe); animation-duration: 8s; }
        .bubble:nth-child(2) { width: 40px; height: 40px; left: 20%; background: radial-gradient(circle, #a8edea, #fed6e3); animation-duration: 6s; }
        .bubble:nth-child(3) { width: 80px; height: 80px; left: 35%; background: radial-gradient(circle, #f093fb, #f5576c); animation-duration: 10s; }
        .bubble:nth-child(4) { width: 50px; height: 50px; left: 50%; background: radial-gradient(circle, #fa709a, #fee140); animation-duration: 7s; }
        .bubble:nth-child(5) { width: 70px; height: 70px; left: 60%; background: radial-gradient(circle, #30cfd0, #c43ad6); animation-duration: 9s; }
        .bubble:nth-child(6) { width: 45px; height: 45px; left: 70%; background: radial-gradient(circle, #a8edea, #fed6e3); animation-duration: 8s; }
        .bubble:nth-child(7) { width: 55px; height: 55px; left: 80%; background: radial-gradient(circle, #ff9a56, #ff6a88); animation-duration: 11s; }
        .bubble:nth-child(8) { width: 65px; height: 65px; left: 15%; background: radial-gradient(circle, #ffecd2, #fcb69f); animation-duration: 7s; }
        @keyframes rise { 0% { bottom: -150px; opacity: 0; } 10% { opacity: 0.7; } 100% { bottom: 110vh; opacity: 0; } }
        
        .chat-container { display: flex; height: 100vh; position: relative; z-index: 1; }
        .main-chat { flex: 1; display: flex; flex-direction: column; }
        .chat-header { background: rgba(102, 126, 234, 0.95); backdrop-filter: blur(10px); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-left h2 { margin: 0; font-size: 24px; }
        .header-left p { margin: 5px 0 0 0; font-size: 14px; opacity: 0.9; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; z-index: 2; width: 100%; }
        .message.own { align-items: flex-end; }
        .message-header { font-size: 12px; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        .message.own .message-header { flex-direction: row-reverse; }
        .message-bubble { display: inline-block; max-width: 70%; min-width: 80px; width: fit-content; padding: 10px 14px; border-radius: 18px; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.15); position: relative; }
        .message-bubble.other { background: rgba(255, 255, 255, 0.98); color: #333; }
        .message-bubble.own { background: rgba(102, 126, 234, 0.98); color: white; }
        
        /* MESSAGE ACTIONS - FOR ALL MESSAGE TYPES */
        .message-actions { position: absolute; top: -12px; right: -12px; display: none; gap: 5px; z-index: 10; }
        .message.own .message-bubble:hover .message-actions { display: flex; }
        .action-icon-btn { background: rgba(102, 126, 234, 0.95); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s; }
        .action-icon-btn:hover { transform: scale(1.1); }
        .action-icon-btn.delete { background: rgba(239, 68, 68, 0.95); }
        
        .message-bubble img { max-width: 300px; max-height: 300px; border-radius: 10px; margin-top: 5px; cursor: pointer; display: block; }
        .message-bubble video { max-width: 400px; max-height: 300px; border-radius: 10px; margin-top: 5px; cursor: pointer; display: block; }
        .message-bubble .caption-text { margin-top: 8px; font-size: 13px; opacity: 0.9; }
        .status-message { text-align: center; color: #333; font-size: 13px; margin: 10px auto; font-style: italic; background: rgba(255, 255, 255, 0.8); padding: 5px 15px; border-radius: 15px; max-width: fit-content; }
        .input-container { background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; z-index: 10; }
        .input-actions { display: flex; gap: 8px; }
        .action-btn { background: #f0f2f5; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .action-btn:hover { background: #e4e6eb; }
        .message-input { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; }
        .message-input:focus { border-color: #667eea; }
        .send-btn { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .send-btn:hover { background: #5568d3; }
        .members-sidebar { width: 280px; background: rgba(255, 255, 255, 0.95); border-left: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-header { padding: 20px; background: rgba(248, 249, 250, 0.95); border-bottom: 1px solid #ddd; }
        .sidebar-header h3 { margin: 0; font-size: 16px; color: #333; }
        .online-count { color: #28a745; font-size: 14px; margin-top: 5px; }
        .members-list { flex: 1; overflow-y: auto; padding: 10px; }
        .member-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; margin-bottom: 5px; }
        .member-item:hover { background: rgba(248, 249, 250, 0.8); }
        .member-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; margin-right: 12px; }
        .member-info { flex: 1; }
        .member-name { font-size: 14px; color: #333; font-weight: 500; }
        .member-status { font-size: 12px; color: #28a745; }
        .typing-indicator { padding: 10px 20px; font-size: 13px; color: #333; font-style: italic; min-height: 35px; background: rgba(255, 255, 255, 0.7); }
        .emoji-picker { position: absolute; bottom: 70px; left: 20px; background: rgba(255, 255, 255, 0.98); border: 1px solid #ddd; border-radius: 10px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; max-width: 350px; z-index: 1000; }
        .emoji-picker.show { display: block; }
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; }
        .emoji-item { font-size: 24px; cursor: pointer; padding: 5px; text-align: center; border-radius: 5px; }
        .emoji-item:hover { background: #f0f2f5; }
        #fileInput { display: none; }
        .loading { display: none; padding: 10px; text-align: center; color: #333; font-size: 13px; background: rgba(255, 255, 255, 0.9); }
        .loading.show { display: block; }
        
        /* CAMERA MODAL */
        .camera-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 9998; justify-content: center; align-items: center; }
        .camera-modal.active { display: flex; }
        .camera-container { background: white; border-radius: 15px; padding: 20px; max-width: 600px; width: 90%; }
        #cameraVideo { width: 100%; display: block; border-radius: 10px; }
        #cameraCanvas { display: none; }
        .camera-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .camera-btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; }
        .camera-btn:hover { background: #5568d3; }
        .camera-btn.secondary { background: #f0f2f5; color: #333; }
        .camera-btn.secondary:hover { background: #e4e6eb; }
        
        /* EDIT MODAL */
        .edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9997; justify-content: center; align-items: center; }
        .edit-modal.active { display: flex; }
        .edit-container { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .edit-container h3 { margin: 0 0 20px 0; color: #333; }
        .edit-input { width: 100%; padding: 12px 16px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; outline: none; resize: vertical; min-height: 80px; font-family: inherit; }
        .edit-input:focus { border-color: #667eea; }
        .edit-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .edit-save-btn, .edit-cancel-btn { padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .edit-save-btn { background: #667eea; color: white; }
        .edit-save-btn:hover { background: #5568d3; }
        .edit-cancel-btn { background: #f0f2f5; color: #333; }
        .edit-cancel-btn:hover { background: #e4e6eb; }
        
        /* LIGHTBOX */
        .media-lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 9999; justify-content: center; align-items: center; }
        .media-lightbox.active { display: flex; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; }
        .lightbox-content img, .lightbox-content video { max-width: 100%; max-height: 90vh; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
        .lightbox-back-btn { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.9); color: #333; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; z-index: 10000; }
        .lightbox-back-btn:hover { background: white; }
        .lightbox-download-btn { position: absolute; top: 20px; right: 20px; background: rgba(102, 126, 234, 0.9); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: 600; z-index: 10000; }
        .lightbox-download-btn:hover { background: #667eea; }
    </style>
</head>
<body>
    <div class="bubbles-container">
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
        <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    </div>

    <div class="chat-container">
        <div class="main-chat">
            <div class="chat-header">
                <div class="header-left">
                    <h2>{{ room.room_name }}</h2>
                    <p>Welcome, {{ username }}!</p>
                    {% if show_room_id %}<p style="font-size: 12px; margin-top: 5px;">üîë Room ID: <strong>{{ room_id }}</strong></p>{% endif %}
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="emoji-picker" id="emojiPicker"><div class="emoji-grid" id="emojiGrid"></div></div>
            <div class="loading" id="loadingIndicator">Uploading...</div>
            <div class="input-container">
                <div class="input-actions">
                    <button class="action-btn" onclick="toggleEmojiPicker()">üòä</button>
                    <button class="action-btn" onclick="openCamera()">üì∑</button>
                    <button class="action-btn" onclick="triggerFileUpload('image')">üñºÔ∏è</button>
                    <button class="action-btn" onclick="triggerFileUpload('video')">üé•</button>
                </div>
                <input type="file" id="fileInput" accept="image/*,video/*" onchange="handleFileSelect(event)">
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div class="members-sidebar">
            <div class="sidebar-header"><h3>üë• Group Members</h3><div class="online-count" id="onlineCount">Loading...</div></div>
            <div class="members-list" id="membersList"></div>
        </div>
    </div>

    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="cameraCanvas"></canvas>
            <div class="camera-controls">
                <button class="camera-btn" onclick="capturePhoto()">üì∏ Capture</button>
                <button class="camera-btn secondary" onclick="closeCamera()">‚úñ Close</button>
            </div>
        </div>
    </div>

    <div class="edit-modal" id="editModal">
        <div class="edit-container">
            <h3>‚úèÔ∏è Edit Message</h3>
            <textarea class="edit-input" id="editInput" placeholder="Edit your message..."></textarea>
            <div class="edit-actions">
                <button class="edit-cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="edit-save-btn" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>

    <div class="media-lightbox" id="mediaLightbox">
        <button class="lightbox-back-btn" onclick="closeLightbox()">‚Üê Back</button>
        <button class="lightbox-download-btn" onclick="downloadMedia()">üì• Download</button>
        <div class="lightbox-content" id="lightboxContent"></div>
    </div>

    <script>
        const socket = io();
        const roomId = '{{ room_id }}';
        const username = '{{ username }}';
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const membersList = document.getElementById('membersList');
        const onlineCount = document.getElementById('onlineCount');
        const emojiPicker = document.getElementById('emojiPicker');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mediaLightbox = document.getElementById('mediaLightbox');
        const lightboxContent = document.getElementById('lightboxContent');
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const editModal = document.getElementById('editModal');
        const editInput = document.getElementById('editInput');

        let typingTimeout;
        let currentMediaUrl = '';
        let cameraStream = null;
        let currentEditMessageId = null;

        const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üëç','üëé','üëè','üôå','üëã','ü§ù','üôè','üí™','‚ù§Ô∏è','üíî','üíØ','üî•','‚ú®','‚≠ê','üéâ','üéä'];

        function initEmojiPicker() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(emojiItem);
            });
        }

        function toggleEmojiPicker() { emojiPicker.classList.toggle('show'); }
        function insertEmoji(emoji) { messageInput.value += emoji; messageInput.focus(); emojiPicker.classList.remove('show'); }
        function triggerFileUpload(type) { const fileInput = document.getElementById('fileInput'); fileInput.accept = type === 'image' ? 'image/*' : 'video/*'; fileInput.click(); }

        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                cameraVideo.srcObject = cameraStream;
                cameraModal.classList.add('active');
            } catch (error) {
                alert('Could not access camera');
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraModal.classList.remove('active');
        }

        function capturePhoto() {
            const canvas = cameraCanvas;
            const video = cameraVideo;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(blob => {
                const file = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
                uploadCameraFile(file);
                closeCamera();
            }, 'image/jpeg', 0.9);
        }

        function uploadCameraFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            loadingIndicator.classList.add('show');

            fetch('/api/upload', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.classList.remove('show');
                if (data.success) {
                    socket.emit('send_message', {
                        room_id: roomId,
                        username: username,
                        message: file.name,
                        message_type: data.file_type,
                        file_url: data.file_url
                    });
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            loadingIndicator.classList.add('show');

            fetch('/api/upload', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.classList.remove('show');
                if (data.success) {
                    socket.emit('send_message', {
                        room_id: roomId,
                        username: username,
                        message: file.name,
                        message_type: data.file_type,
                        file_url: data.file_url
                    });
                    event.target.value = '';
                }
            });
        }

        function openEditModal(messageId, currentText) {
            currentEditMessageId = messageId;
            editInput.value = currentText;
            editModal.classList.add('active');
            editInput.focus();
        }

        function closeEditModal() {
            editModal.classList.remove('active');
            currentEditMessageId = null;
            editInput.value = '';
        }

        function saveEdit() {
            const newText = editInput.value.trim();
            if (!newText) {
                alert('Message cannot be empty');
                return;
            }
            socket.emit('edit_message', {
                room_id: roomId,
                message_id: currentEditMessageId,
                new_text: newText,
                username: username
            });
            closeEditModal();
        }

        function deleteMessage(messageId) {
            if (confirm('Delete this message?')) {
                socket.emit('delete_message', {
                    room_id: roomId,
                    message_id: messageId,
                    username: username
                });
            }
        }

        function openLightbox(mediaUrl, mediaType) {
            currentMediaUrl = mediaUrl;
            lightboxContent.innerHTML = '';
            if (mediaType === 'image') {
                const img = document.createElement('img');
                img.src = mediaUrl;
                lightboxContent.appendChild(img);
            } else {
                const video = document.createElement('video');
                video.src = mediaUrl;
                video.controls = true;
                video.autoplay = true;
                lightboxContent.appendChild(video);
            }
            mediaLightbox.classList.add('active');
        }

        function closeLightbox() { mediaLightbox.classList.remove('active'); lightboxContent.innerHTML = ''; }
        function downloadMedia() { if (currentMediaUrl) window.open(currentMediaUrl, '_blank'); }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeLightbox(); closeEditModal(); closeCamera(); } });
        mediaLightbox.addEventListener('click', (e) => { if (e.target === mediaLightbox) closeLightbox(); });
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

        socket.on('connect', () => {
            socket.emit('join_room', { room_id: roomId, username: username });
            loadMessageHistory();
            initEmojiPicker();
        });

        function loadMessageHistory() {
            fetch(`/api/room/${roomId}/messages`)
                .then(res => res.json())
                .then(data => {
                    data.messages.forEach(msg => displayMessage(msg.username, msg.message, msg.timestamp, msg.message_type, msg.file_url, msg.id, false));
                    scrollToBottom();
                });
        }

        socket.on('receive_message', (data) => displayMessage(data.username, data.message, data.timestamp, data.message_type, data.file_url, data.id, true));
        socket.on('user_joined', (data) => { displayStatus(data.message); updateMembersList(); });
        socket.on('user_left', (data) => { displayStatus(data.message); updateMembersList(); });
        socket.on('user_typing', (data) => { typingIndicator.textContent = data.is_typing ? `${data.username} is typing...` : ''; });

        socket.on('message_edited', (data) => {
            document.querySelectorAll('.message').forEach(el => {
                if (el.getAttribute('data-message-id') == data.message_id) {
                    const bubble = el.querySelector('.message-bubble');
                    const textNode = bubble.childNodes[0];
                    if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                        textNode.textContent = data.new_text + ' (edited)';
                    }
                }
            });
        });

        socket.on('message_deleted', (data) => {
            document.querySelectorAll('.message').forEach(el => {
                if (el.getAttribute('data-message-id') == data.message_id) {
                    el.remove();
                }
            });
        });

        function displayMessage(sender, message, time, messageType = 'text', fileUrl = null, messageId = null, scroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === username ? 'message own' : 'message';
            if (messageId) messageDiv.setAttribute('data-message-id', messageId);

            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.innerHTML = `<strong>${sender}</strong> <span>${time}</span>`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = sender === username ? 'message-bubble own' : 'message-bubble other';
            
            if (messageType === 'image' && fileUrl) {
                const img = document.createElement('img');
                img.src = fileUrl;
                img.onclick = () => openLightbox(fileUrl, 'image');
                bubbleDiv.appendChild(img);
                if (message) {
                    const caption = document.createElement('div');
                    caption.className = 'caption-text';
                    caption.textContent = message;
                    bubbleDiv.appendChild(caption);
                }
            } else if (messageType === 'video' && fileUrl) {
                const video = document.createElement('video');
                video.src = fileUrl;
                video.onclick = () => openLightbox(fileUrl, 'video');
                bubbleDiv.appendChild(video);
                if (message) {
                    const caption = document.createElement('div');
                    caption.className = 'caption-text';
                    caption.textContent = message;
                    bubbleDiv.appendChild(caption);
                }
            } else {
                bubbleDiv.textContent = message;
            }

            // ADD DELETE BUTTON FOR ALL OWN MESSAGES (TEXT, IMAGE, VIDEO)
            if (sender === username) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Only add edit button for text messages
                if (messageType === 'text') {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-icon-btn';
                    editBtn.textContent = '‚úèÔ∏è';
                    editBtn.onclick = () => openEditModal(messageId, message);
                    actionsDiv.appendChild(editBtn);
                }
                
                // Add delete button for ALL message types
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-icon-btn delete';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteMessage(messageId);
                actionsDiv.appendChild(deleteBtn);
                
                bubbleDiv.appendChild(actionsDiv);
            }

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);
            if (scroll) scrollToBottom();
        }

        function displayStatus(message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-message';
            statusDiv.textContent = message;
            messagesContainer.appendChild(statusDiv);
            scrollToBottom();
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', { room_id: roomId, username: username, message: message, message_type: 'text' });
                messageInput.value = '';
                emojiPicker.classList.remove('show');
            }
        }

        messageInput.addEventListener('input', () => {
            socket.emit('typing', { room_id: roomId, username: username, is_typing: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { room_id: roomId, username: username, is_typing: false }), 1000);
        });

        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        document.addEventListener('click', (e) => { if (!e.target.closest('.emoji-picker') && !e.target.closest('.action-btn')) emojiPicker.classList.remove('show'); });

        function updateMembersList() {
            fetch(`/api/room/${roomId}/members`)
                .then(res => res.json())
                .then(data => {
                    onlineCount.textContent = `${data.online_count} online`;
                    membersList.innerHTML = '';
                    data.online_members.forEach(member => {
                        const memberDiv = document.createElement('div');
                        memberDiv.className = 'member-item';
                        const initial = member.charAt(0).toUpperCase();
                        memberDiv.innerHTML = `<div class="member-avatar">${initial}</div><div class="member-info"><div class="member-name">${member}</div><div class="member-status">‚óè Online</div></div>`;
                        membersList.appendChild(memberDiv);
                    });
                });
        }

        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
        function logout() { socket.emit('leave_room', { room_id: roomId, username: username }); window.location.href = '/logout'; }
        updateMembersList();
    </script>
</body>
</html>
